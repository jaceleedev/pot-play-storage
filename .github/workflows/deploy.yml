name: Pot-Play-Storage CI/CD Pipeline

on:
  push:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/pot-play-storage

jobs:
  # ===============================================
  # 1. í…ŒìŠ¤íŠ¸ Job: Go ì½”ë“œ í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œ ê²€ì¦
  # ===============================================
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.22'

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Install dependencies
      run: go mod download

    - name: Run tests
      env:
        DB_HOST: localhost
        DB_PORT: 5432
        DB_USER: test_user
        DB_PASSWORD: test_password
        DB_NAME: test_db
        DB_SSL_MODE: disable
        REDIS_HOST: localhost
        REDIS_PORT: 6379
        API_KEY: test-api-key
      run: go test -v -race ./...

    - name: Build binary
      run: go build -o bin/server ./cmd/main.go

  # ===============================================
  # 2. ë¹Œë“œ & í‘¸ì‹œ Job: Docker ì´ë¯¸ì§€ ë¹Œë“œí•˜ê³  GHCRì— í‘¸ì‹œ
  # ===============================================
  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        platforms: linux/amd64
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # ===============================================
  # 3. ë°°í¬ Job: ì„œë²„ì— ë°°í¬
  # ===============================================
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy to Server via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: root
        password: ${{ secrets.SSH_ROOT_PASSWORD }}
        script: |
          set -e
          
          # 1. ë°°í¬ ë””ë ‰í† ë¦¬ í™•ì¸ ë° ìƒì„±
          if [ ! -d /home/pot-play-storage ]; then
            echo "ğŸ“ ë°°í¬ ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤..."
            mkdir -p /home/pot-play-storage
            cd /home/pot-play-storage
            git clone https://github.com/${{ github.repository }}.git .
          else
            cd /home/pot-play-storage
          fi
          
          # 2. ìµœì‹  ì½”ë“œ pull
          echo "ğŸ”„ ìµœì‹  ì½”ë“œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤..."
          git pull origin main
          
          # 3. í™˜ê²½ ë³€ìˆ˜ í™•ì¸ ë° ìƒì„±
          if [ ! -f .env ]; then
            echo "âš ï¸ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. .env.exampleì—ì„œ ë³µì‚¬í•©ë‹ˆë‹¤..."
            cp .env.example .env
            echo "âœ… .env íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. (ê¸°ë³¸ê°’ ì‚¬ìš©ì¤‘)"
            echo "âš ï¸ ë‚˜ì¤‘ì— ë‹¤ìŒ ê°’ë“¤ì„ ìˆ˜ì •í•˜ì„¸ìš”: DB_PASSWORD, REDIS_PASSWORD, API_KEY"
          fi
          
          # 4. deploy.sh ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          echo "ğŸ”§ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ì„¤ì •..."
          chmod +x deploy.sh
          
          # 5. GHCR ë¡œê·¸ì¸ì„ ìœ„í•œ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          export GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"
          export GITHUB_ACTOR="${{ github.actor }}"
          
          # 6. deploy.sh ìŠ¤í¬ë¦½íŠ¸ë¡œ ë°°í¬
          echo "ğŸš€ deploy.sh ìŠ¤í¬ë¦½íŠ¸ë¡œ ë°°í¬ ì‹œì‘..."
          ./deploy.sh deploy
          
          # 7. ë°°í¬ ê²°ê³¼ í™•ì¸
          echo "ğŸ“Š ìµœì¢… ë°°í¬ ìƒíƒœ:"
          docker compose -f docker-compose.prod.yml ps