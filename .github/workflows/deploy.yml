name: Pot-Play-Storage CI/CD Pipeline

on:
  push:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/pot-play-storage

jobs:
  # ===============================================
  # 1. í…ŒìŠ¤íŠ¸ Job: Go ì½”ë“œ í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œ ê²€ì¦
  # ===============================================
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.22'

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Install dependencies
      run: go mod download

    - name: Run tests
      env:
        DB_HOST: localhost
        DB_PORT: 5432
        DB_USER: test_user
        DB_PASSWORD: test_password
        DB_NAME: test_db
        DB_SSL_MODE: disable
        REDIS_HOST: localhost
        REDIS_PORT: 6379
        API_KEY: test-api-key
      run: go test -v -race ./...

    - name: Build binary
      run: go build -o bin/server ./cmd/main.go

  # ===============================================
  # 2. ë¹Œë“œ & í‘¸ì‹œ Job: Docker ì´ë¯¸ì§€ ë¹Œë“œí•˜ê³  GHCRì— í‘¸ì‹œ
  # ===============================================
  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        platforms: linux/amd64
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # ===============================================
  # 3. ë°°í¬ Job: ì„œë²„ì— ë°°í¬
  # ===============================================
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy to Server via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: root
        password: ${{ secrets.SSH_ROOT_PASSWORD }}
        script: |
          set -e
          
          # 1. ë°°í¬ ë””ë ‰í† ë¦¬ í™•ì¸ ë° ìƒì„±
          if [ ! -d /home/pot-play-storage ]; then
            echo "ğŸ“ ë°°í¬ ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤..."
            mkdir -p /home/pot-play-storage
            cd /home/pot-play-storage
            git clone https://github.com/${{ github.repository }}.git .
          else
            cd /home/pot-play-storage
          fi
          
          # 2. ìµœì‹  ì½”ë“œ pull
          echo "ğŸ”„ ìµœì‹  ì½”ë“œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤..."
          git pull origin main
          
          # 3. í™˜ê²½ ë³€ìˆ˜ í™•ì¸ ë° ë³µì‚¬
          if [ ! -f .env ]; then
            echo "âŒ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìƒì„±í•´ì£¼ì„¸ìš”!"
            exit 1
          fi
          
          # deploy ë””ë ‰í† ë¦¬ì— .env íŒŒì¼ ë³µì‚¬ (Docker Composeê°€ ì½ì„ ìˆ˜ ìˆë„ë¡)
          cp .env deploy/.env
          
          # 4. í•„ìš”í•œ ë””ë ‰í† ë¦¬ ìƒì„± (Docker ë³¼ë¥¨ ë§ˆìš´íŠ¸ë¥¼ ìœ„í•´)
          echo "ğŸ“ í•„ìš”í•œ ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤..."
          mkdir -p deploy
          mkdir -p deploy/data/{postgres,redis,seaweedfs/{master,volume,filer}}
          mkdir -p deploy/{uploads,backups,configs}
          
          # 5. GHCR ë¡œê·¸ì¸
          echo "ğŸ” GitHub Container Registry ë¡œê·¸ì¸..."
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # 6. ìµœì‹  ì´ë¯¸ì§€ pull
          echo "ğŸ“¦ ìµœì‹  Docker ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤..."
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          
          # 7. docker-compose.yml ì—…ë°ì´íŠ¸ (ì´ë¯¸ì§€ íƒœê·¸)
          echo "ğŸ“ docker-compose.yml ì—…ë°ì´íŠ¸..."
          sed -i "s|image: .*pot-play-storage.*|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest|g" deploy/docker-compose.prod.yml
          
          # 8. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ë°±ì—…
          echo "ğŸ›‘ ê¸°ì¡´ ì„œë¹„ìŠ¤ë¥¼ ì¤‘ì§€í•©ë‹ˆë‹¤..."
          cd deploy && docker compose -f docker-compose.prod.yml stop api || true && cd ..
          
          # 9. ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
          echo "ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰..."
          cd deploy && docker compose -f docker-compose.prod.yml run --rm api sh -c "
            if [ -f /app/migrations/001_initial.sql ]; then
              PGPASSWORD=\$DB_PASSWORD psql -h \$DB_HOST -U \$DB_USER -d \$DB_NAME -f /app/migrations/001_initial.sql || true
            fi
          " && cd ..
          
          # 10. ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘
          echo "ğŸš€ ìƒˆ ë²„ì „ì„ ì‹œì‘í•©ë‹ˆë‹¤..."
          cd deploy && docker compose -f docker-compose.prod.yml up -d && cd ..
          
          # 11. í—¬ìŠ¤ ì²´í¬
          echo "â¤ï¸ í—¬ìŠ¤ ì²´í¬ ì¤‘..."
          sleep 10
          for i in {1..30}; do
            if curl -f http://localhost:8090/health; then
              echo "âœ… ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
              break
            fi
            echo "â³ ì„œë¹„ìŠ¤ê°€ ì‹œì‘ë˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘... ($i/30)"
            sleep 2
          done
          
          # 12. ë¡œê·¸ í™•ì¸
          echo "ğŸ“œ ìµœê·¼ ë¡œê·¸:"
          docker compose -f deploy/docker-compose.prod.yml logs --tail=50 api
          
          # 13. ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì •ë¦¬
          echo "ğŸ§¹ ì˜¤ë˜ëœ ì´ë¯¸ì§€ë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤..."
          docker image prune -f