# ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

[â† ì´ì „: README](./README.md) | [ë‹¤ìŒ: API â†’](./API.md)

---

Pot Play Storageì˜ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ì™€ êµ¬ì„± ìš”ì†Œë¥¼ ì„¤ëª…í•©ë‹ˆë‹¤.

## ğŸ—ï¸ ì „ì²´ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client Apps   â”‚â”€â”€â”€â”€â”‚   API Gateway    â”‚â”€â”€â”€â”€â”‚   Load Balancer â”‚
â”‚  (Mobile/Web)   â”‚    â”‚   (Future)       â”‚    â”‚    (Future)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     API Server          â”‚
                    â”‚   (Go + Gin)            â”‚
                    â”‚   Port: 8090            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PostgreSQL    â”‚    â”‚     Redis       â”‚    â”‚    Storage      â”‚
â”‚  (Metadata)     â”‚    â”‚   (Cache)       â”‚    â”‚   (Files)       â”‚
â”‚  Port: 5432     â”‚    â”‚  Port: 6379     â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                        â”‚
                                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                       â”‚                                 â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ Local Storage   â”‚              â”‚   SeaweedFS     â”‚
                              â”‚ (Development)   â”‚              â”‚ (Production)    â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                        â”‚
                                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                          â”‚             â”‚             â”‚
                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                   â”‚   Master    â”‚ â”‚   Volume    â”‚ â”‚   Filer     â”‚
                                                   â”‚ Port: 9333  â”‚ â”‚ Port: 8081  â”‚ â”‚ Port: 8888  â”‚
                                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ í•µì‹¬ êµ¬ì„±ìš”ì†Œ

### 1. API Server (Go + Gin)
**ì—­í• **: RESTful API ì œê³µ ë° ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬

**êµ¬ì„± ìš”ì†Œ**:
- **Handler Layer**: HTTP ìš”ì²­/ì‘ë‹µ ì²˜ë¦¬
- **Service Layer**: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ êµ¬í˜„
- **Repository Layer**: ë°ì´í„° ì•¡ì„¸ìŠ¤ ì¶”ìƒí™”

**íŠ¹ì§•**:
- Graceful shutdown ì§€ì›
- êµ¬ì¡°í™”ëœ ë¡œê¹… (Zap)
- ë¯¸ë“¤ì›¨ì–´ ê¸°ë°˜ í™•ì¥ì„±

### 2. PostgreSQL (ë©”íƒ€ë°ì´í„° ì €ì¥ì†Œ)
**ì—­í• **: íŒŒì¼ ë©”íƒ€ë°ì´í„° ë° ì‹œìŠ¤í…œ ë°ì´í„° ì €ì¥

**ìŠ¤í‚¤ë§ˆ**:
```sql
-- ê³ ìœ  íŒŒì¼ ì½˜í…ì¸  ì €ì¥
CREATE TABLE storage (
    hash VARCHAR(64) PRIMARY KEY,
    size BIGINT NOT NULL,
    content_type VARCHAR(255),
    storage_path VARCHAR(500),
    reference_count INT DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì‚¬ìš©ìë³„ íŒŒì¼ ì°¸ì¡°
CREATE TABLE files (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(255) NOT NULL,
    storage_hash VARCHAR(64) REFERENCES storage(hash),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    -- ê¸°ì¡´ ë°ì´í„° í˜¸í™˜ì„±ì„ ìœ„í•œ ë ˆê±°ì‹œ ì»¬ëŸ¼
    size BIGINT,
    content_type VARCHAR(100),
    storage_path VARCHAR(500),
    checksum VARCHAR(64)
);
```

**ì¸ë±ìŠ¤**:
- `idx_storage_hash`: ë¹ ë¥¸ í•´ì‹œ ì¡°íšŒ
- `idx_files_storage_hash`: íŒŒì¼-ìŠ¤í† ë¦¬ì§€ ì—°ê²°
- `idx_files_created_at`: ì‹œê°„ìˆœ ì •ë ¬ìš©
- `idx_files_checksum`: ë ˆê±°ì‹œ í˜¸í™˜ì„±

### 3. Redis (ìºì‹œ ì‹œìŠ¤í…œ)
**ì—­í• **: ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ ë©”ëª¨ë¦¬ ìºì‹œ

**ìºì‹œ ì „ëµ**:
- **íŒŒì¼ ë©”íƒ€ë°ì´í„°**: 1ì‹œê°„ TTL
- **íŒŒì¼ ëª©ë¡**: 10ë¶„ TTL
- **Write-through**: ì—…ë°ì´íŠ¸ ì‹œ ìºì‹œ ë¬´íš¨í™”

### 4. Storage Abstraction (ìŠ¤í† ë¦¬ì§€ ì¶”ìƒí™”)
**ì—­í• **: ë‹¤ì–‘í•œ ìŠ¤í† ë¦¬ì§€ ë°±ì—”ë“œ ì§€ì›

**ì¸í„°í˜ì´ìŠ¤**:
```go
type Storage interface {
    Put(ctx context.Context, path string, reader io.Reader, size int64) (int64, error)
    Get(ctx context.Context, path string) (io.ReadCloser, error)
    Delete(ctx context.Context, path string) error
    List(ctx context.Context, prefix string) ([]string, error)
}
```

**êµ¬í˜„ì²´**:
- **LocalStorage**: ë¡œì»¬ íŒŒì¼ì‹œìŠ¤í…œ ê¸°ë°˜ (ê°œë°œ/í…ŒìŠ¤íŠ¸ìš©)
- **SeaweedFSStorage**: ë¶„ì‚° íŒŒì¼ì‹œìŠ¤í…œ (í”„ë¡œë•ì…˜ìš©)

## ğŸ“Š ë°ì´í„° í”Œë¡œìš°

### íŒŒì¼ ì—…ë¡œë“œ í”Œë¡œìš°
```
1. Client â†’ API Server: POST /api/v1/files (multipart/form-data)
2. API Server: íŒŒì¼ ê²€ì¦ (í¬ê¸°, íƒ€ì…, ë³´ì•ˆ)
3. API Server: SHA256 í•´ì‹œ ê³„ì‚°
4. API Server â†’ PostgreSQL: í•´ì‹œë¡œ ê¸°ì¡´ íŒŒì¼ í™•ì¸
5. (ì¤‘ë³µì¸ ê²½ìš°) 
   a. API Server â†’ PostgreSQL: reference_count ì¦ê°€
   b. API Server â†’ PostgreSQL: files í…Œì´ë¸”ì— ì°¸ì¡° ì¶”ê°€
6. (ì‹ ê·œ íŒŒì¼ì¸ ê²½ìš°)
   a. API Server â†’ Storage: íŒŒì¼ ì €ì¥
   b. API Server â†’ PostgreSQL: storage í…Œì´ë¸” ì¶”ê°€
   c. API Server â†’ PostgreSQL: files í…Œì´ë¸”ì— ì°¸ì¡° ì¶”ê°€
7. API Server â†’ Redis: ìºì‹œ ê°±ì‹ 
8. API Server â†’ Client: íŒŒì¼ ì •ë³´ ì‘ë‹µ
```

### íŒŒì¼ ë‹¤ìš´ë¡œë“œ í”Œë¡œìš°
```
1. Client â†’ API Server: GET /api/v1/files/{id}
2. API Server â†’ Redis: ë©”íƒ€ë°ì´í„° ìºì‹œ í™•ì¸
3. (ìºì‹œ ë¯¸ìŠ¤) API Server â†’ PostgreSQL: ë©”íƒ€ë°ì´í„° ì¡°íšŒ
4. API Server â†’ Storage: íŒŒì¼ ìŠ¤íŠ¸ë¦¼ ì¡°íšŒ
5. API Server â†’ Client: íŒŒì¼ ìŠ¤íŠ¸ë¦¼ ì „ì†¡
```

### íŒŒì¼ ì‚­ì œ í”Œë¡œìš°
```
1. Client â†’ API Server: DELETE /api/v1/files/{id}
2. API Server â†’ PostgreSQL: íŒŒì¼ ì •ë³´ ì¡°íšŒ
3. API Server â†’ PostgreSQL: files í…Œì´ë¸”ì—ì„œ ì°¸ì¡° ì‚­ì œ
4. API Server â†’ PostgreSQL: reference_count ê°ì†Œ
5. (reference_count = 0ì¸ ê²½ìš°)
   a. API Server â†’ Storage: ì‹¤ì œ íŒŒì¼ ì‚­ì œ
   b. API Server â†’ PostgreSQL: storage í…Œì´ë¸”ì—ì„œ ì‚­ì œ
6. API Server â†’ Redis: ìºì‹œ ë¬´íš¨í™”
7. API Server â†’ Client: ì„±ê³µ ì‘ë‹µ
```

## ğŸ”’ ë³´ì•ˆ ì•„í‚¤í…ì²˜

### íŒŒì¼ ê²€ì¦ ë ˆì´ì–´
1. **íŒŒì¼ í¬ê¸° ê²€ì¦**: 100MB ì œí•œ
2. **MIME íƒ€ì… ê²€ì¦**: í—ˆìš©ëœ íƒ€ì…ë§Œ ì—…ë¡œë“œ
3. **íŒŒì¼ëª… ê²€ì¦**: ê²½ë¡œ íƒìƒ‰ ê³µê²© ë°©ì§€
4. **í™•ì¥ì ê²€ì¦**: ìœ„í—˜í•œ ì‹¤í–‰ íŒŒì¼ ì°¨ë‹¨

### ë³´ì•ˆ í—¤ë”
```go
c.Header("Cache-Control", "no-cache, no-store, must-revalidate")
c.Header("X-Content-Type-Options", "nosniff")
c.Header("Content-Disposition", "attachment; filename=\"...\"")
```

## ğŸš€ í™•ì¥ì„± ì„¤ê³„

### ìˆ˜í‰ì  í™•ì¥ ê°€ëŠ¥ ìš”ì†Œ
- **API Server**: ë¡œë“œë°¸ëŸ°ì„œë¥¼ í†µí•œ ë‹¤ì¤‘ ì¸ìŠ¤í„´ìŠ¤
- **SeaweedFS**: ë¶„ì‚° íŒŒì¼ì‹œìŠ¤í…œìœ¼ë¡œ ìŠ¤í† ë¦¬ì§€ í™•ì¥
- **Redis**: Redis Clusterë¡œ ìºì‹œ í™•ì¥
- **PostgreSQL**: ì½ê¸° ë³µì œë³¸ ì¶”ê°€ ê°€ëŠ¥

### ìˆ˜ì§ì  í™•ì¥ ê°€ëŠ¥ ìš”ì†Œ
- **ë©”ëª¨ë¦¬**: Redis ìºì‹œ í¬ê¸° ì¦ê°€
- **CPU**: Goì˜ ë©€í‹°ì½”ì–´ í™œìš©
- **ìŠ¤í† ë¦¬ì§€**: SeaweedFS ë³¼ë¥¨ ì„œë²„ ì¶”ê°€

## ğŸ³ ë°°í¬ ì•„í‚¤í…ì²˜

### Development (Docker Compose)
```yaml
services:
  api:          # API Server
  postgres:     # ë©”íƒ€ë°ì´í„° DB
  redis:        # ìºì‹œ
  seaweedfs-*:  # ë¶„ì‚° ìŠ¤í† ë¦¬ì§€ (Master, Volume, Filer)
```

### Production (ê¶Œì¥ êµ¬ì„±)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Load Balancer   â”‚ (nginx/HAProxy)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ API Servers     â”‚ (multiple instances)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Database        â”‚ (PostgreSQL cluster)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Cache           â”‚ (Redis cluster)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Storage         â”‚ (SeaweedFS cluster)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ˆ ì„±ëŠ¥ íŠ¹ì„±

### ì²˜ë¦¬ëŸ‰ (ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ ê¸°ì¤€)
- **ì—…ë¡œë“œ**: ~100MB/s (ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­ ì˜ì¡´)
- **ë‹¤ìš´ë¡œë“œ**: ~200MB/s (ìºì‹œ ë° ìŠ¤í† ë¦¬ì§€ ì„±ëŠ¥ ì˜ì¡´)
- **ë©”íƒ€ë°ì´í„° ì¡°íšŒ**: ~1000 req/s (Redis ìºì‹œ í™œìš© ì‹œ)

### ë ˆì´í„´ì‹œ
- **íŒŒì¼ ì—…ë¡œë“œ**: íŒŒì¼ í¬ê¸°ì— ë¹„ë¡€
- **ë©”íƒ€ë°ì´í„° ì¡°íšŒ**: <10ms (ìºì‹œ íˆíŠ¸ ì‹œ)
- **íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹œì‘**: <50ms

## ğŸ”„ ì„¤ê³„ ì›ì¹™

### 1. ë‹¨ì¼ ì±…ì„ ì›ì¹™
ê° ë ˆì´ì–´ì™€ ì»´í¬ë„ŒíŠ¸ëŠ” ëª…í™•í•œ ë‹¨ì¼ ì±…ì„ì„ ê°€ì§‘ë‹ˆë‹¤.

### 2. ì˜ì¡´ì„± ì—­ì „
ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•œ ì¶”ìƒí™”ë¡œ êµ¬í˜„ì²´ ë³€ê²½ì´ ìš©ì´í•©ë‹ˆë‹¤.

### 3. í™•ì¥ ê°€ëŠ¥ì„±
ìƒˆë¡œìš´ ìŠ¤í† ë¦¬ì§€ ë°±ì—”ë“œë‚˜ ê¸°ëŠ¥ ì¶”ê°€ê°€ ìš©ì´í•œ êµ¬ì¡°ì…ë‹ˆë‹¤.

### 4. ì¥ì•  ê²©ë¦¬
ê° ì»´í¬ë„ŒíŠ¸ì˜ ì¥ì• ê°€ ì „ì²´ ì‹œìŠ¤í…œì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ ìµœì†Œí™”í•©ë‹ˆë‹¤.

---

*ì´ ì•„í‚¤í…ì²˜ëŠ” MVP ë‹¨ê³„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•˜ë©°, í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” ì¶”ê°€ì ì¸ ë³´ì•ˆ, ëª¨ë‹ˆí„°ë§, ë°±ì—… ë“±ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.*