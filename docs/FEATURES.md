# 기능 명세서

[← 이전: API](./API.md) | [다음: 기술 문서 →](./TECHNICAL.md)

---

Pot Play Storage의 현재 기능과 향후 로드맵을 설명합니다.

## ✅ 현재 MVP 기능

### 1. 파일 관리 (File Management)

#### 📤 파일 업로드
- **기능**: 멀티파트 폼 데이터를 통한 파일 업로드
- **지원 포맷**:
  - 이미지: JPG, JPEG, PNG, GIF, WebP, AVIF
  - 동영상: MP4, AVI, MOV
  - 문서: PDF, TXT
  - 압축: ZIP
- **제한사항**:
  - 최대 파일 크기: 100MB
  - 파일명 길이: 1-255자
- **보안 검증**:
  - MIME 타입 검증
  - 위험한 확장자 차단
  - 파일명 검증 (경로 탐색 방지)

#### 📥 파일 다운로드
- **기능**: UUID 기반 파일 식별 및 스트리밍 다운로드
- **특징**:
  - 직접 스트리밍 (메모리 효율적)
  - 적절한 Content-Type 헤더 설정
  - 보안 헤더 적용
  - 중복 파일도 개별 URL로 접근 가능
- **보안**: 경로 탐색 공격 방지

#### 🗑️ 파일 삭제
- **기능**: UUID를 통한 파일 및 메타데이터 삭제
- **특징**:
  - 원자적 삭제 (스토리지 + 메타데이터)
  - 캐시 자동 무효화
  - 참조 카운팅: 중복 파일은 마지막 참조가 삭제될 때만 실제 삭제
- **오류 복구**: 부분 삭제 시 정리 로직

#### 📋 파일 목록
- **기능**: 저장된 모든 파일의 메타데이터 조회
- **반환 정보**: ID, 이름, 크기, 타입, 생성일, 체크섬
- **정렬**: 생성일 기준 내림차순

### 2. 스토리지 시스템 (Storage System)

#### 🏠 로컬 스토리지
- **용도**: 개발 및 테스트 환경
- **특징**: 파일시스템 기반 단순 구현
- **경로**: 설정 가능한 베이스 디렉토리

#### 🌐 SeaweedFS 분산 스토리지
- **용도**: 프로덕션 환경
- **특징**:
  - 수평적 확장 가능
  - 고가용성 지원
  - 자동 복제
- **구성**: Master, Volume, Filer 서버

### 3. 메타데이터 관리 (Metadata Management)

#### 🗄️ PostgreSQL 데이터베이스
- **저장 정보**:
  - 파일 ID (UUID)
  - 파일명, 크기, 타입
  - 스토리지 경로
  - SHA-256 체크섬
  - 생성 시간
- **인덱스**: 체크섬, 생성시간 기반 최적화

#### 🔄 중복 파일 처리 (Content-Based Storage)
- **기능**: SHA256 해시 기반 자동 중복 제거
- **작동 방식**:
  - 업로드 시 파일 해시 계산
  - 동일한 해시 존재 시 스토리지 재사용
  - 각 사용자는 고유한 파일명 유지
- **장점**:
  - 스토리지 공간 대폭 절약
  - 빠른 중복 파일 감지
  - 동일 파일의 다중 참조 지원
- **참조 카운팅**: 
  - 파일별 참조 수 추적
  - 마지막 참조 삭제 시에만 실제 스토리지 삭제
- **데이터 구조**:
  - `storage` 테이블: 고유 콘텐츠 저장
  - `files` 테이블: 사용자별 파일 메타데이터

#### ⚡ Redis 캐싱
- **캐시 대상**:
  - 개별 파일 메타데이터 (1시간 TTL)
  - 파일 목록 (10분 TTL)
- **캐시 전략**: Write-through, 무효화 기반

### 4. 보안 및 검증 (Security & Validation)

#### 🛡️ 파일 검증
- **파일명 검증**:
  - 위험한 문자 차단 (`<>:"|?*` 등)
  - 제어 문자 차단
  - Windows 예약 이름 차단
  - 경로 탐색 차단 (`../`, `./` 등)
- **확장자 검증**:
  - 허용 목록 기반
  - 실행 파일 차단 (`.exe`, `.bat`, `.sh` 등)
- **MIME 타입 검증**: 확장자와 일치성 확인

#### 🔒 보안 헤더
```http
Cache-Control: no-cache, no-store, must-revalidate
X-Content-Type-Options: nosniff
Content-Disposition: attachment; filename="..."
```

### 5. 시스템 운영 (System Operations)

#### 📊 로깅 시스템
- **로거**: Structured logging (Zap)
- **로그 레벨**: DEBUG, INFO, WARN, ERROR
- **로그 내용**: 요청 추적, 오류 상세, 성능 메트릭

#### 🐳 컨테이너화
- **Docker**: 멀티스테이지 빌드
- **Docker Compose**: 전체 시스템 오케스트레이션
- **볼륨**: 데이터 영속성 보장

## 📊 기능 비교표

| 기능 | 현재 상태 | 복잡도 | 우선순위 |
|------|-----------|--------|----------|
| 파일 업로드 | ✅ 완료 | 중간 | 높음 |
| 파일 다운로드 | ✅ 완료 | 낮음 | 높음 |
| 파일 삭제 | ✅ 완료 | 낮음 | 높음 |
| 파일 목록 | ✅ 완료 | 낮음 | 높음 |
| 로컬 스토리지 | ✅ 완료 | 낮음 | 중간 |
| SeaweedFS 스토리지 | ✅ 완료 | 높음 | 높음 |
| Redis 캐싱 | ✅ 완료 | 중간 | 중간 |
| 파일 검증 | ✅ 완료 | 중간 | 높음 |
| 보안 헤더 | ✅ 완료 | 낮음 | 높음 |
| 로깅 | ✅ 완료 | 낮음 | 중간 |

## 🚧 향후 개발 로드맵

### Phase 1: 보안 및 인증 (Priority: 높음)

#### 🔐 사용자 인증
- **JWT 토큰 기반 인증**
  - 토큰 발급/갱신 엔드포인트
  - 미들웨어 기반 인증 검증
  - 토큰 만료 관리
- **API 키 관리**
  - 다중 API 키 지원
  - 키별 권한 설정
  - 키 회전 기능

#### 👥 사용자 관리
- **사용자 등록/로그인**
- **사용자별 파일 격리**
- **역할 기반 접근 제어 (RBAC)**

### Phase 2: 고급 파일 기능 (Priority: 중간)

#### 🖼️ 이미지 처리
- **썸네일 자동 생성**
  - 다양한 크기 지원 (150x150, 300x300, 600x600)
  - WebP 형식 최적화
  - 비동기 처리
- **이미지 메타데이터 추출**
  - EXIF 데이터 읽기
  - 해상도, 색상 공간 정보
- **이미지 변환**
  - 포맷 변환 (JPG ↔ PNG ↔ WebP)
  - 크기 조정
  - 회전/뒤집기

#### 📹 동영상 처리
- **동영상 썸네일 생성**
- **메타데이터 추출** (해상도, 길이, 코덱)
- **트랜스코딩** (품질 조정)

#### 📁 파일 조직화
- **폴더/디렉토리 지원**
- **태그 시스템**
- **파일 검색 (이름, 태그, 메타데이터)**
- **파일 분류 자동화**

### Phase 3: 운영 및 모니터링 (Priority: 중간)

#### 📈 모니터링 시스템
- **Prometheus 메트릭 수집**
  - API 응답 시간
  - 처리량 (req/s)
  - 오류율
  - 스토리지 사용량
- **Grafana 대시보드**
- **알림 시스템** (Slack, 이메일)

#### 🔄 백업 및 복구
- **자동 백업**
  - 증분 백업
  - 스케줄링
- **재해 복구 계획**
- **데이터 무결성 검증**

### Phase 4: 성능 및 확장성 (Priority: 낮음)

#### ⚡ 성능 최적화
- **CDN 통합** (CloudFront, CloudFlare)
- **압축 및 캐싱 최적화**
- **연결 풀링 개선**
- **배치 작업 지원**

#### 🔄 고급 캐싱
- **다층 캐시 구조**
- **캐시 예열**
- **캐시 히트율 최적화**

#### 📊 배치 처리
- **대용량 파일 업로드** (멀티파트/청크)
- **배치 삭제/이동**
- **벌크 메타데이터 업데이트**

### Phase 5: 고급 기능 (Future)

#### 🔗 API 개선
- **GraphQL 지원**
- **웹훅 시스템**
- **API 버저닝**
- **Rate Limiting**

#### 🌐 다중 클라우드 지원
- **AWS S3 백엔드**
- **Google Cloud Storage**
- **Azure Blob Storage**
- **하이브리드 클라우드 전략**

#### 🤖 AI/ML 통합
- **자동 태깅** (이미지 인식)
- **중복 파일 감지**
- **컨텐츠 기반 검색**

## 📋 기술 부채 및 개선 사항

### 현재 알려진 제한사항
1. **인증 부재**: 기본적인 API 키만 지원
2. **단일 테넌트**: 사용자 격리 미지원
3. **제한된 메타데이터**: 기본 파일 정보만 저장
4. **단순한 오류 처리**: 세분화된 오류 코드 부족
5. **모니터링 부족**: 기본 로깅만 제공

### 기술 개선 계획
1. **설정 관리 개선**: 환경별 설정 분리
2. **테스트 커버리지 향상**: 현재 ~60% → 목표 90%
3. **API 문서 자동화**: OpenAPI/Swagger 통합
4. **CI/CD 파이프라인**: 자동 테스트 및 배포
5. **코드 품질**: Linting, 정적 분석 도구 도입

---

*이 로드맵은 사용자 피드백과 비즈니스 요구사항에 따라 조정될 수 있습니다.*